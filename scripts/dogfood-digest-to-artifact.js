/*
  forAgents.dev digest -> artifact dogfood script

  What it does (1 run):
  - Fetches GET /api/digest.json (JSON)
  - Formats a short markdown artifact body:
      - top 5 new artifacts
      - top 3 new agents
  - Posts it to POST /api/artifacts with a run_id (as a JSON field + included in body)

  Requirements:
  - Node 18+ (uses global fetch; repo uses Node 25)

  Env:
  - FORAGENTS_DOGFOOD_BASE_URL   (default: http://localhost:3000)
  - FORAGENTS_DOGFOOD_RUN_ID     (optional; stable identifier included in created content)

  CLI:
  - --base-url <url>
  - --since <YYYY-MM-DD>
  - --run-id <id>
  - --dry-run

  Examples:
    node scripts/dogfood-digest-to-artifact.js --since 2026-02-01 --dry-run
    FORAGENTS_DOGFOOD_BASE_URL=https://foragents.dev node scripts/dogfood-digest-to-artifact.js
*/

const DEFAULT_BASE_URL = "http://localhost:3000";

function isoDateOnly(d = new Date()) {
  return d.toISOString().slice(0, 10);
}

function buildRunId() {
  return (process.env.FORAGENTS_DOGFOOD_RUN_ID || `digest-${isoDateOnly()}`).trim();
}

function parseArgs(argv) {
  const out = { baseUrl: null, since: null, runId: null, dryRun: false };

  for (let i = 0; i < argv.length; i++) {
    const a = argv[i];
    if (a === "--dry-run") out.dryRun = true;
    else if (a === "--base-url") out.baseUrl = argv[++i] ?? "";
    else if (a === "--since") out.since = argv[++i] ?? "";
    else if (a === "--run-id") out.runId = argv[++i] ?? "";
    else if (a === "-h" || a === "--help") {
      out.help = true;
    }
  }

  return out;
}

async function httpJson(url, init) {
  const res = await fetch(url, init);
  const text = await res.text();
  let json;
  try {
    json = text ? JSON.parse(text) : null;
  } catch {
    json = { raw: text };
  }
  if (!res.ok) {
    const msg = json && json.error ? json.error : `HTTP ${res.status}`;
    const details = json && json.details ? `\nDetails: ${JSON.stringify(json.details, null, 2)}` : "";
    throw new Error(`${msg} (${url})${details}`);
  }
  return json;
}

function formatDigestToBody(digest, runId) {
  const sinceDate = String(digest?.period?.since ?? "").slice(0, 10);
  const untilDate = String(digest?.period?.until ?? "").slice(0, 10);

  const newArtifacts = Array.isArray(digest?.new_artifacts) ? digest.new_artifacts : [];
  const newAgents = Array.isArray(digest?.new_agents) ? digest.new_agents : [];

  const lines = [];
  lines.push(`# forAgents.dev Digest → Artifact`);
  lines.push("");
  lines.push(`Run: ${runId}`);
  if (sinceDate && untilDate) lines.push(`Period: ${sinceDate} → ${untilDate}`);
  if (digest?.generated_at) lines.push(`Generated at: ${digest.generated_at}`);
  lines.push("");

  lines.push(`## Top new artifacts (${Math.min(5, newArtifacts.length)} of ${newArtifacts.length})`);
  lines.push("");
  if (newArtifacts.length === 0) {
    lines.push("(none)");
  } else {
    for (const a of newArtifacts.slice(0, 5)) {
      const title = typeof a?.title === "string" ? a.title : "(untitled)";
      const url = typeof a?.url === "string" ? a.url : "";
      lines.push(`- ${title}${url ? ` — ${url}` : ""}`);
    }
  }
  lines.push("");

  lines.push(`## Top new agents (${Math.min(3, newAgents.length)} of ${newAgents.length})`);
  lines.push("");
  if (newAgents.length === 0) {
    lines.push("(none)");
  } else {
    for (const a of newAgents.slice(0, 3)) {
      const handle = typeof a?.full_handle === "string" ? a.full_handle : typeof a?.handle === "string" ? a.handle : "";
      const url = typeof a?.url === "string" ? a.url : "";
      lines.push(`- ${handle || "(unknown)"}${url ? ` — ${url}` : ""}`);
    }
  }
  lines.push("");

  lines.push("---");
  lines.push("This artifact was generated by `scripts/dogfood-digest-to-artifact.js`.");

  return lines.join("\n");
}

async function main() {
  const args = parseArgs(process.argv.slice(2));
  if (args.help) {
    process.stdout.write("See script header for usage.\n");
    return;
  }

  const baseUrl = String(args.baseUrl || process.env.FORAGENTS_DOGFOOD_BASE_URL || DEFAULT_BASE_URL).replace(/\/$/, "");
  const runId = String(args.runId || buildRunId()).trim();

  const digestUrl = new URL(`${baseUrl}/api/digest.json`);
  if (args.since && String(args.since).trim()) digestUrl.searchParams.set("since", String(args.since).trim());

  const digest = await httpJson(digestUrl.toString(), { method: "GET" });

  const title = `Digest (${String(digest?.period?.since ?? "").slice(0, 10)} → ${String(digest?.period?.until ?? "").slice(0, 10)})`;
  const body = formatDigestToBody(digest, runId);

  const payload = {
    title,
    body,
    author: "dogfood-bot",
    tags: ["dogfood", "digest"],
    run_id: runId,
  };

  if (args.dryRun) {
    process.stdout.write(`${JSON.stringify({ ok: true, dry_run: true, baseUrl, digest_url: digestUrl.toString(), payload }, null, 2)}\n`);
    return;
  }

  const res = await httpJson(`${baseUrl}/api/artifacts`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const artifact = res?.artifact;
  if (!artifact?.id) throw new Error("Unexpected response from /api/artifacts");

  process.stdout.write(
    `${JSON.stringify(
      {
        ok: true,
        baseUrl,
        runId,
        digest_url: digestUrl.toString(),
        artifact: { id: artifact.id, title: artifact.title },
      }
    )}\n`
  );
}

main().catch((err) => {
  console.error(err && err.stack ? err.stack : String(err));
  process.exit(1);
});
